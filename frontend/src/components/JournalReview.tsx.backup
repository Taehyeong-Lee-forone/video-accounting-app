'use client'

import { useState, useRef, useEffect } from 'react'
import { useVideoDetail } from '@/hooks/useVideoDetail'
import { useJournals } from '@/hooks/useJournals'
import { api } from '@/lib/api'
import toast from 'react-hot-toast'
import { format } from 'date-fns'
import { ja } from 'date-fns/locale'
import ReactPlayer from 'react-player'
import JournalTable from './JournalTable'
import { ArrowDownTrayIcon, CameraIcon, PlusIcon, XMarkIcon, PencilIcon, CheckIcon, XCircleIcon, ClockIcon } from '@heroicons/react/24/outline'

interface JournalReviewProps {
  videoId: number
}

export default function JournalReview({ videoId }: JournalReviewProps) {
  const { data: video, isLoading: videoLoading } = useVideoDetail(videoId)
  const { data: journals, isLoading: journalsLoading, refetch } = useJournals(videoId)
  const [selectedJournal, setSelectedJournal] = useState<any>(null)
  const [selectedReceipt, setSelectedReceipt] = useState<any>(null)
  const [playerReady, setPlayerReady] = useState(false)
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [videoDuration, setVideoDuration] = useState(0)
  const [currentTime, setCurrentTime] = useState(0)
  const [hoveredReceiptId, setHoveredReceiptId] = useState<number | null>(null)
  const [editingReceiptId, setEditingReceiptId] = useState<number | null>(null)
  const [editForm, setEditForm] = useState<any>({})
  const [showHistory, setShowHistory] = useState<number | null>(null)
  const [selectedReceiptIds, setSelectedReceiptIds] = useState<Set<number>>(new Set())
  const [isSelectionMode, setIsSelectionMode] = useState(false)
  const [groupByVendor, setGroupByVendor] = useState(false)
  const playerRef = useRef<ReactPlayer>(null)

  const handleJournalClick = (journal: any) => {
    setSelectedJournal(journal)
    
    // 動画を該当時刻にシーク
    if (playerRef.current && journal.time_ms) {
      const seconds = journal.time_ms / 1000
      playerRef.current.seekTo(seconds)
    }
  }

  const handleReceiptClick = (receipt: any) => {
    setSelectedReceipt(receipt)
    console.log('Receipt clicked:', receipt)
    console.log('Best frame:', receipt.best_frame)
    console.log('Time ms:', receipt.best_frame?.time_ms)
    console.log('Player ready:', playerReady)
    console.log('Player ref:', playerRef.current)
    
    // 영수증의 프레임 시간으로 동영상 이동
    if (receipt.best_frame?.time_ms !== undefined) {
      const seconds = receipt.best_frame.time_ms / 1000
      console.log('Attempting to seek to seconds:', seconds)
      
      // 다양한 방법으로 시도
      if (playerRef.current) {
        try {
          // 방법 1: 직접 seekTo 호출
          playerRef.current.seekTo(seconds, 'seconds')
          console.log('Method 1: Direct seekTo called')
        } catch (e) {
          console.error('Method 1 failed:', e)
        }
        
        // 방법 2: 내부 플레이어 접근
        try {
          const internalPlayer = (playerRef.current as any).getInternalPlayer()
          if (internalPlayer && internalPlayer.currentTime !== undefined) {
            internalPlayer.currentTime = seconds
            console.log('Method 2: Set currentTime directly')
          }
        } catch (e) {
          console.error('Method 2 failed:', e)
        }
      }
    }
  }

  const handlePlayerReady = () => {
    console.log('Player is ready')
    setPlayerReady(true)
    if (playerRef.current) {
      setVideoDuration(playerRef.current.getDuration())
    }
  }

  const handleProgress = (state: { played: number; playedSeconds: number }) => {
    setCurrentTime(state.playedSeconds)
  }

  const handleDuration = (duration: number) => {
    setVideoDuration(duration)
  }

  const handleMarkerClick = (timeMs: number) => {
    if (playerRef.current) {
      const seconds = timeMs / 1000
      playerRef.current.seekTo(seconds)
    }
  }

  const handleAnalyzeCurrentFrame = async () => {
    if (!playerRef.current || !playerReady) {
      toast.error('動画プレイヤーが準備できていません')
      return
    }

    try {
      setIsAnalyzing(true)
      
      // 現在の再生位置を取得（秒 → ミリ秒）
      const currentTime = playerRef.current.getCurrentTime()
      const timeMs = Math.floor(currentTime * 1000)
      
      console.log('Analyzing frame at:', timeMs, 'ms')
      
      // APIで現在のフレームを分析
      const response = await api.post(`/api/videos/${videoId}/analyze-frame`, null, {
        params: { time_ms: timeMs }
      })
      
      if (response.data.receipt_id) {
        toast.success(`フレーム分析完了: ${timeMs}ms`)
        
        // ページをリロードして新しい領収書を表示
        // より良い方法は React Query のキャッシュを無効化すること
        window.location.reload()
      } else {
        toast.warning('領収書データを抽出できませんでした')
      }
    } catch (error: any) {
      console.error('Frame analysis error:', error)
      toast.error(error.response?.data?.detail || 'フレーム分析に失敗しました')
    } finally {
      setIsAnalyzing(false)
    }
  }

  const handleConfirm = async (journalId: number) => {
    try {
      await api.post(`/api/journals/${journalId}/confirm`, {
        confirmed_by: 'user'
      })
      toast.success('仕訳を確認しました')
      refetch()
    } catch (error) {
      toast.error('確認に失敗しました')
    }
  }

  const handleReject = async (journalId: number) => {
    try {
      await api.post(`/api/journals/${journalId}/reject`)
      toast.success('仕訳を差戻しました')
      refetch()
    } catch (error) {
      toast.error('差戻しに失敗しました')
    }
  }

  const handleUpdate = async (journalId: number, data: any) => {
    try {
      await api.patch(`/api/journals/${journalId}`, data)
      toast.success('仕訳を更新しました')
      refetch()
    } catch (error) {
      toast.error('更新に失敗しました')
    }
  }

  const handleEditReceipt = (receipt: any, event?: React.MouseEvent) => {
    if (event) event.stopPropagation()
    
    setEditingReceiptId(receipt.id)
    setEditForm({
      vendor: receipt.vendor || '',
      total: receipt.total || 0,
      tax: receipt.tax || 0,
      issue_date: receipt.issue_date ? format(new Date(receipt.issue_date), 'yyyy-MM-dd') : '',
      payment_method: receipt.payment_method || '',
      memo: receipt.memo || ''
    })
  }

  const handleSaveEdit = async (receiptId: number, event?: React.MouseEvent) => {
    if (event) event.stopPropagation()
    
    try {
      // 日付フォーマット変換
      const updateData = {
        ...editForm,
        issue_date: editForm.issue_date ? new Date(editForm.issue_date).toISOString() : null,
        total: parseFloat(editForm.total) || 0,
        tax: parseFloat(editForm.tax) || 0
      }
      
      await api.patch(`/api/videos/${videoId}/receipts/${receiptId}`, updateData)
      toast.success('領収書を更新しました')
      
      // 編集モード終了
      setEditingReceiptId(null)
      setEditForm({})
      
      // ページリロード（React Query使用時は refetch()）
      window.location.reload()
    } catch (error: any) {
      console.error('Update receipt error:', error)
      toast.error(error.response?.data?.detail || '更新に失敗しました')
    }
  }

  const handleCancelEdit = (event?: React.MouseEvent) => {
    if (event) event.stopPropagation()
    setEditingReceiptId(null)
    setEditForm({})
  }

  const handleShowHistory = async (receiptId: number, event?: React.MouseEvent) => {
    if (event) event.stopPropagation()
    
    if (showHistory === receiptId) {
      setShowHistory(null)
    } else {
      setShowHistory(receiptId)
      
      // 이력 데이터 가져오기
      try {
        const response = await api.get(`/api/videos/${videoId}/receipts/${receiptId}/history`)
        console.log('History data:', response.data)
        // 이력은 이미 receipt.history에 포함되어 있어야 하지만
        // 필요시 별도로 상태 관리 가능
      } catch (error) {
        console.error('Failed to fetch history:', error)
      }
    }
  }

  const handleReceiptSelect = (receiptId: number, event?: React.MouseEvent) => {
    if (event) event.stopPropagation()
    
    const newSelected = new Set(selectedReceiptIds)
    if (newSelected.has(receiptId)) {
      newSelected.delete(receiptId)
    } else {
      newSelected.add(receiptId)
    }
    setSelectedReceiptIds(newSelected)
  }
  
  const handleSelectAll = () => {
    if (!video?.receipts) return
    
    if (selectedReceiptIds.size === video.receipts.length) {
      setSelectedReceiptIds(new Set())
    } else {
      const allIds = new Set(video.receipts.map((r: any) => r.id))
      setSelectedReceiptIds(allIds)
    }
  }
  
  const handleBulkDelete = async () => {
    if (selectedReceiptIds.size === 0) return
    
    const confirmMessage = `${selectedReceiptIds.size}件の領収書を削除しますか？\n関連する仕訳データも削除されます。`
    if (!confirm(confirmMessage)) return
    
    try {
      // 各領収書を削除
      const deletePromises = Array.from(selectedReceiptIds).map(id =>
        api.delete(`/api/videos/${videoId}/receipts/${id}`)
      )
      
      await Promise.all(deletePromises)
      toast.success(`${selectedReceiptIds.size}件の領収書を削除しました`)
      
      // 選択をクリア
      setSelectedReceiptIds(new Set())
      setIsSelectionMode(false)
      
      // ページリロード
      window.location.reload()
    } catch (error: any) {
      console.error('Bulk delete error:', error)
      toast.error('一括削除に失敗しました')
    }
  }
  
  const handleDeleteReceipt = async (receiptId: number, event: React.MouseEvent) => {
    event.stopPropagation() // カードのクリックイベントを防ぐ
    
    const confirmMessage = '本当にこの領収書を削除しますか？\n関連する仕訳データも削除されます。'
    if (!confirm(confirmMessage)) {
      return
    }
    
    try {
      await api.delete(`/api/videos/${videoId}/receipts/${receiptId}`)
      toast.success('領収書を削除しました')
      
      // ページをリロードして更新（React Queryのキャッシュ無効化の方が良い）
      window.location.reload()
    } catch (error: any) {
      console.error('Delete receipt error:', error)
      toast.error(error.response?.data?.detail || '削除に失敗しました')
    }
  }

  const handleExportCSV = async () => {
    try {
      const response = await api.get(`/api/export/csv?video_id=${videoId}`, {
        responseType: 'blob'
      })
      
      const url = window.URL.createObjectURL(new Blob([response.data]))
      const link = document.createElement('a')
      link.href = url
      link.setAttribute('download', `journal_export_${videoId}.csv`)
      document.body.appendChild(link)
      link.click()
      link.remove()
      
      toast.success('CSVをダウンロードしました')
    } catch (error) {
      toast.error('エクスポートに失敗しました')
    }
  }

  if (videoLoading || journalsLoading) {
    return <div className="card">読み込み中...</div>
  }

  if (!video) {
    return <div className="card">動画が見つかりません</div>
  }

  // デバッグ用
  console.log('Video data:', video)
  console.log('Journals data:', journals)

  // レシートカードのレンダリング関数
  const renderReceiptCard = (receipt: any, index: number) => {
    return (
      <div
        key={receipt.id}
        className={`relative border rounded-lg p-4 cursor-pointer transition-all group ${
          selectedReceipt?.id === receipt.id
            ? 'border-blue-500 bg-blue-50 shadow-md'
            : selectedReceiptIds.has(receipt.id)
            ? 'border-blue-300 bg-blue-50'
            : 'hover:bg-gray-50'
        }`}
        onClick={() => !isSelectionMode && handleReceiptClick(receipt)}
        onMouseEnter={() => setHoveredReceiptId(receipt.id)}
        onMouseLeave={() => setHoveredReceiptId(null)}
        title={isSelectionMode ? "選択/選択解除" : "クリックして動画を該当時刻へ移動"}
      >
        {/* 選択モード時のチェックボックス */}
        {isSelectionMode && (
          <div className="absolute top-2 left-2">
            <input
              type="checkbox"
              checked={selectedReceiptIds.has(receipt.id)}
              onChange={(e) => {
                e.stopPropagation()
                handleReceiptSelect(receipt.id)
              }}
              className="w-5 h-5 cursor-pointer"
            />
          </div>
        )}

        {/* 順序番号 */}
        <div className={`absolute top-2 ${isSelectionMode ? 'left-10' : 'left-2'} w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs font-medium text-gray-700`}>
          {index + 1}
        </div>

        {/* その他の既存コンテンツはそのまま残す */}
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold text-gray-900">仕訳レビュー</h1>
        <button
          onClick={handleExportCSV}
          className="btn-primary flex items-center"
        >
          <ArrowDownTrayIcon className="h-5 w-5 mr-2" />
          CSV出力
        </button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* 動画プレイヤー - 左側に固定 */}
        <div className="lg:sticky lg:top-6" style={{ height: 'fit-content', alignSelf: 'start' }}>
          <div className="card">
            <h2 className="text-xl font-semibold mb-4">動画</h2>
            <div className="relative">
              <ReactPlayer
                ref={playerRef}
                url={video.local_path ? `http://localhost:8000/${video.local_path}` : ''}
                controls
                width="100%"
                height="400px"
                onReady={handlePlayerReady}
                onProgress={handleProgress}
                onDuration={handleDuration}
              />
            </div>
            
            {/* タイムラインマーカー */}
            {videoDuration > 0 && video.receipts && video.receipts.length > 0 && (
              <div className="mt-3">
                <div className="text-xs text-gray-600 mb-1">領収書タイムライン:</div>
                <div className="relative bg-gray-200 h-8 rounded-lg overflow-hidden">
                  {/* 現在の再生位置 */}
                  <div 
                    className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-20"
                    style={{ left: `${(currentTime / videoDuration) * 100}%` }}
                  />
                  
                  {/* 領収書マーカー */}
                  {video.receipts.map((receipt: any) => {
                    if (!receipt.best_frame?.time_ms) return null
                    const position = (receipt.best_frame.time_ms / 1000 / videoDuration) * 100
                    
                    return (
                      <div
                        key={receipt.id}
                        className={`absolute top-1 bottom-1 w-2 rounded-full cursor-pointer transform -translate-x-1/2 transition-all hover:scale-125 z-10 ${
                          receipt.is_manual ? 'bg-green-500' : 'bg-blue-500'
                        } ${selectedReceipt?.id === receipt.id ? 'ring-2 ring-yellow-400' : ''}`}
                        style={{ left: `${position}%` }}
                        onClick={() => {
                          handleMarkerClick(receipt.best_frame.time_ms)
                          handleReceiptClick(receipt)
                        }}
                        title={`${receipt.vendor || '不明'} - ${Math.floor(receipt.best_frame.time_ms / 1000)}秒${
                          receipt.is_manual ? ' (手動追加)' : ''
                        }`}
                      />
                    )
                  })}
                </div>
                <div className="flex justify-between text-xs text-gray-500 mt-1">
                  <span>0:00</span>
                  <span>{Math.floor(videoDuration / 60)}:{String(Math.floor(videoDuration % 60)).padStart(2, '0')}</span>
                </div>
                <div className="flex items-center gap-4 text-xs text-gray-600 mt-2">
                  <span className="flex items-center">
                    <span className="w-2 h-2 bg-blue-500 rounded-full mr-1"></span>
                    自動検出
                  </span>
                  <span className="flex items-center">
                    <span className="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                    手動追加
                  </span>
                  <span className="flex items-center">
                    <span className="w-0.5 h-3 bg-red-500 mr-1"></span>
                    現在位置
                  </span>
                </div>
              </div>
            )}
            
            <div className="mt-4">
              {/* 手動フレーム分析ボタン */}
              <div className="flex items-center gap-2">
                <button
                  onClick={handleAnalyzeCurrentFrame}
                  disabled={isAnalyzing || !playerReady}
                  className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                    isAnalyzing || !playerReady
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      : 'bg-blue-600 text-white hover:bg-blue-700'
                  }`}
                >
                  {isAnalyzing ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      分析中...
                    </>
                  ) : (
                    <>
                      <CameraIcon className="h-4 w-4 mr-2" />
                      現在のフレームを分析
                    </>
                  )}
                </button>
                <span className="text-xs text-gray-500">
                  動画を一時停止して、分析したい位置で使用してください
                </span>
              </div>
            </div>
          </div>
        </div>

        {/* 領収書情報 - 右側でスクロール可能、高さを増やす */}
        <div className="card overflow-hidden flex flex-col" style={{ height: 'calc(100vh - 200px)', maxHeight: '800px' }}>
          <div className="flex justify-between items-center mb-4 flex-shrink-0">
            <h2 className="text-xl font-semibold">領収書情報</h2>
            <div className="flex gap-2">
              {/* 選択モード切替 */}
              <button
                onClick={() => {
                  setIsSelectionMode(!isSelectionMode)
                  setSelectedReceiptIds(new Set())
                }}
                className={`px-3 py-1 rounded text-sm ${
                  isSelectionMode 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                {isSelectionMode ? '選択モード終了' : '選択モード'}
              </button>
              
              {/* グループ化切替 */}
              <button
                onClick={() => setGroupByVendor(!groupByVendor)}
                className={`px-3 py-1 rounded text-sm ${
                  groupByVendor 
                    ? 'bg-green-500 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                {groupByVendor ? 'グループ解除' : '業者別グループ'}
              </button>
            </div>
          </div>
          
          {/* 一括操作バー */}
          {isSelectionMode && (
            <div className="bg-blue-50 p-3 rounded mb-3 flex justify-between items-center flex-shrink-0">
              <div className="flex items-center gap-3">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={video?.receipts && selectedReceiptIds.size === video.receipts.length}
                    onChange={handleSelectAll}
                    className="mr-2"
                  />
                  <span className="text-sm">全て選択 ({selectedReceiptIds.size}件選択中)</span>
                </label>
              </div>
              
              <div className="flex gap-2">
                <button
                  onClick={handleBulkDelete}
                  disabled={selectedReceiptIds.size === 0}
                  className={`px-4 py-1 rounded text-sm ${
                    selectedReceiptIds.size > 0
                      ? 'bg-red-500 text-white hover:bg-red-600'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  一括削除
                </button>
              </div>
            </div>
          )}
          {video.receipts && video.receipts.length > 0 ? (
            <div className="space-y-4 overflow-y-auto pr-3 custom-scrollbar" style={{ flex: 1 }}>
              {/* 타임라인 순서로 정렬 또는 업체별 그룹핑 */}
              {(() => {
                const sortedReceipts = [...video.receipts].sort((a, b) => {
                  const timeA = a.best_frame?.time_ms || 0
                  const timeB = b.best_frame?.time_ms || 0
                  return timeA - timeB
                })
                
                if (groupByVendor) {
                  // 업체별로 그룹핑
                  const grouped = sortedReceipts.reduce((acc: any, receipt: any) => {
                    const vendor = receipt.vendor || '不明'
                    if (!acc[vendor]) acc[vendor] = []
                    acc[vendor].push(receipt)
                    return acc
                  }, {})
                  
                  return Object.entries(grouped).map(([vendor, receipts]: [string, any]) => (
                    <div key={vendor} className="mb-6">
                      <h3 className="text-sm font-semibold text-gray-700 mb-2 sticky top-0 bg-white z-10 py-1">
                        {vendor} ({receipts.length}件)
                      </h3>
                      {receipts.map((receipt: any, index: number) => renderReceiptCard(receipt, index))}
                    </div>
                  ))
                } else {
                  // 通常の表示
                  return sortedReceipts.map((receipt: any, index: number) => renderReceiptCard(receipt, index))
                }
              })()}
            </div>
          ) : (
            <p className="text-gray-500">領収書データがありません</p>
          )}
        </div>
      </div>

      {/* 仕訳テーブル */}
      <div className="card mt-6">
        <h2 className="text-xl font-semibold mb-4">仕訳候補</h2>
        {journals && journals.length > 0 ? (
          <JournalTable
            journals={journals}
            onRowClick={handleJournalClick}
            onConfirm={handleConfirm}
            onReject={handleReject}
            onUpdate={handleUpdate}
            selectedId={selectedJournal?.id}
          />
        ) : (
          <p className="text-gray-500">仕訳データがありません</p>
        )}
      </div>
    </div>
  ) 
                  key={receipt.id} 
                  className={`relative border rounded-lg p-4 cursor-pointer transition-all group ${
                    selectedReceipt?.id === receipt.id 
                      ? 'border-blue-500 bg-blue-50 shadow-md' 
                      : selectedReceiptIds.has(receipt.id)
                      ? 'border-blue-300 bg-blue-50'
                      : 'hover:bg-gray-50'
                  }`}
                  onClick={() => !isSelectionMode && handleReceiptClick(receipt)}
                  onMouseEnter={() => setHoveredReceiptId(receipt.id)}
                  onMouseLeave={() => setHoveredReceiptId(null)}
                  title={isSelectionMode ? "選択/選択解除" : "クリックして動画を該当時刻へ移動"}
                >
                  {/* 選択モード時のチェックボックス */}
                  {isSelectionMode && (
                    <div className="absolute top-2 left-2">
                      <input
                        type="checkbox"
                        checked={selectedReceiptIds.has(receipt.id)}
                        onChange={(e) => {
                          e.stopPropagation()
                          handleReceiptSelect(receipt.id)
                        }}
                        className="w-5 h-5 cursor-pointer"
                      />
                    </div>
                  )}
                  
                  {/* 順序番号 */}
                  <div className={`absolute top-2 ${isSelectionMode ? 'left-10' : 'left-2'} w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs font-medium text-gray-700`}>
                    {index + 1}
                  </div>
                  
                  {/* アクションボタン（ホバー時のみ表示） */}
                  <div className={`absolute top-2 right-2 flex gap-1 transition-all ${
                    hoveredReceiptId === receipt.id || selectedReceipt?.id === receipt.id || editingReceiptId === receipt.id
                      ? 'opacity-100'
                      : 'opacity-0 pointer-events-none'
                  }`}>
                    {editingReceiptId === receipt.id ? (
                      <>
                        <button
                          onClick={(e) => handleSaveEdit(receipt.id, e)}
                          className="p-1.5 rounded-lg bg-green-50 hover:bg-green-100 transition-colors"
                          title="保存"
                        >
                          <CheckIcon className="h-5 w-5 text-green-600" />
                        </button>
                        <button
                          onClick={(e) => handleCancelEdit(e)}
                          className="p-1.5 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors"
                          title="キャンセル"
                        >
                          <XCircleIcon className="h-5 w-5 text-gray-600" />
                        </button>
                      </>
                    ) : (
                      <>
                        <button
                          onClick={(e) => handleEditReceipt(receipt, e)}
                          className="p-1.5 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors"
                          title="編集"
                        >
                          <PencilIcon className="h-5 w-5 text-blue-600" />
                        </button>
                        <button
                          onClick={(e) => handleShowHistory(receipt.id, e)}
                          className="p-1.5 rounded-lg bg-yellow-50 hover:bg-yellow-100 transition-colors"
                          title="修正履歴"
                        >
                          <ClockIcon className="h-5 w-5 text-yellow-600" />
                        </button>
                        <button
                          onClick={(e) => handleDeleteReceipt(receipt.id, e)}
                          className="p-1.5 rounded-lg bg-red-50 hover:bg-red-100 transition-colors"
                          title="削除"
                        >
                          <XMarkIcon className="h-5 w-5 text-red-600" />
                        </button>
                      </>
                    )}
                  </div>
                  
                  {/* 手動追加バッジ */}
                  <div className="ml-8 mb-3">
                    {receipt.is_manual && (
                      <div className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <PlusIcon className="h-3 w-3 mr-1" />
                        手動追加
                      </div>
                    )}
                  </div>
                  
                  {/* プレビュー画像とタイムスタンプ */}
                  {receipt.best_frame && (
                    <div className="mb-4 flex items-start gap-4">
                      <div className="flex-shrink-0">
                        <img 
                          src={`http://localhost:8000/api/videos/frames/${receipt.best_frame.id}/image`}
                          alt={`Frame at ${receipt.best_frame.time_ms}ms`}
                          className="w-32 h-24 object-cover rounded border"
                        />
                        <div className="text-xs text-gray-500 mt-1">
                          {Math.floor(receipt.best_frame.time_ms / 1000)}秒 ({receipt.best_frame.time_ms}ms)
                        </div>
                      </div>
                      <div className="flex-grow">
                        <div className="text-sm text-gray-600 mb-2">
                          <span className="font-medium">抽出タイミング:</span> 動画の{Math.floor(receipt.best_frame.time_ms / 1000)}秒目
                          {selectedReceipt?.id === receipt.id && (
                            <span className="ml-2 text-blue-600 font-semibold">← 現在選択中</span>
                          )}
                        </div>
                        <div className="text-xs text-gray-500">
                          フレームスコア: {receipt.best_frame.frame_score?.toFixed(2) || '-'}
                        </div>
                      </div>
                    </div>
                  )}
                  
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div>
                      <span className="font-medium">ベンダー:</span>{' '}
                      {editingReceiptId === receipt.id ? (
                        <input
                          type="text"
                          value={editForm.vendor}
                          onChange={(e) => setEditForm({...editForm, vendor: e.target.value})}
                          onClick={(e) => e.stopPropagation()}
                          className="inline-block w-32 px-1 py-0.5 text-sm border rounded"
                        />
                      ) : (
                        receipt.vendor || '-'
                      )}
                    </div>
                    <div>
                      <span className="font-medium">種別:</span> {receipt.document_type || '-'}
                    </div>
                    <div>
                      <span className="font-medium">日付:</span>{' '}
                      {editingReceiptId === receipt.id ? (
                        <input
                          type="date"
                          value={editForm.issue_date}
                          onChange={(e) => setEditForm({...editForm, issue_date: e.target.value})}
                          onClick={(e) => e.stopPropagation()}
                          className="inline-block px-1 py-0.5 text-sm border rounded"
                        />
                      ) : (
                        receipt.issue_date
                          ? (() => {
                              try {
                                return format(new Date(receipt.issue_date), 'yyyy/MM/dd', { locale: ja })
                              } catch {
                                return receipt.issue_date
                              }
                            })()
                          : '-'
                      )}
                    </div>
                    <div>
                      <span className="font-medium">合計:</span>{' '}
                      {editingReceiptId === receipt.id ? (
                        <>
                          ¥<input
                            type="number"
                            value={editForm.total}
                            onChange={(e) => setEditForm({...editForm, total: e.target.value})}
                            onClick={(e) => e.stopPropagation()}
                            className="inline-block w-24 px-1 py-0.5 text-sm border rounded"
                          />
                        </>
                      ) : (
                        `¥${receipt.total?.toLocaleString() || '0'}`
                      )}
                    </div>
                    <div>
                      <span className="font-medium">税額:</span>{' '}
                      {editingReceiptId === receipt.id ? (
                        <>
                          ¥<input
                            type="number"
                            value={editForm.tax}
                            onChange={(e) => setEditForm({...editForm, tax: e.target.value})}
                            onClick={(e) => e.stopPropagation()}
                            className="inline-block w-20 px-1 py-0.5 text-sm border rounded"
                          />
                        </>
                      ) : (
                        `¥${receipt.tax?.toLocaleString() || '0'}`
                      )}
                    </div>
                    <div>
                      <span className="font-medium">税率:</span>{' '}
                      {receipt.tax_rate ? `${Math.round(receipt.tax_rate * 100)}%` : '-'}
                    </div>
                    <div>
                      <span className="font-medium">支払方法:</span> {receipt.payment_method || '-'}
                    </div>
                    <div>
                      <span className="font-medium">ステータス:</span>{' '}
                      <span className={`inline-flex px-2 py-1 text-xs rounded-full ${
                        receipt.status === 'confirmed'
                          ? 'bg-green-100 text-green-800'
                          : receipt.status === 'rejected'
                          ? 'bg-red-100 text-red-800'
                          : 'bg-yellow-100 text-yellow-800'
                      }`}>
                        {receipt.status === 'confirmed' ? '確認済' :
                         receipt.status === 'rejected' ? '差戻し' : '未確認'}
                      </span>
                    </div>
                  </div>
                  {receipt.duplicate_of_id && (
                    <div className="mt-2 p-2 bg-yellow-50 rounded text-sm text-yellow-800">
                      重複の可能性があります (ID: {receipt.duplicate_of_id})
                    </div>
                  )}
                  
                  {/* 修正履歴 */}
                  {showHistory === receipt.id && receipt.history && receipt.history.length > 0 && (
                    <div className="mt-3 p-3 bg-gray-50 rounded-lg">
                      <h4 className="text-xs font-semibold text-gray-700 mb-2">修正履歴</h4>
                      <div className="space-y-1 max-h-32 overflow-y-auto">
                        {receipt.history.map((h: any) => (
                          <div key={h.id} className="text-xs text-gray-600">
                            <span className="font-medium">{h.field_name}:</span>{' '}
                            <span className="line-through text-gray-400">{h.old_value || '(空)'}</span>
                            {' → '}
                            <span className="text-gray-800">{h.new_value || '(空)'}</span>
                            <span className="text-gray-400 ml-2">
                              ({format(new Date(h.changed_at), 'MM/dd HH:mm')})
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-500">領収書データがありません</p>
          )}
        </div>
      </div>

      {/* 仕訳テーブル */}
      <div className="card mt-6">
        <h2 className="text-xl font-semibold mb-4">仕訳候補</h2>
        {journals && journals.length > 0 ? (
          <JournalTable
            journals={journals}
            onRowClick={handleJournalClick}
            onConfirm={handleConfirm}
            onReject={handleReject}
            onUpdate={handleUpdate}
            selectedId={selectedJournal?.id}
          />
        ) : (
          <p className="text-gray-500">仕訳データがありません</p>
        )}
      </div>
    </div>
  )
}